#!/bin/sh
# Pre-commit hook: keep this fast as an early validation gate
set -e

ROOT_DIR=$(pwd)

run_cargo() {
  if command -v rustup >/dev/null 2>&1; then
    RUSTC_BIN=$(rustup which --toolchain stable rustc 2>/dev/null || true)
    CARGO_BIN=$(rustup which --toolchain stable cargo 2>/dev/null || true)
    if [ -n "$RUSTC_BIN" ] && [ -n "$CARGO_BIN" ]; then
      RUSTC_VER=$("$RUSTC_BIN" --version | awk '{print $2}' | tr '.' '_')
      TOOLCHAIN_BIN=$(dirname "$RUSTC_BIN")
      PATH="$TOOLCHAIN_BIN:$PATH" RUSTC="$RUSTC_BIN" CARGO_TARGET_DIR="$ROOT_DIR/target-rustup-$RUSTC_VER" "$CARGO_BIN" "$@"
      return
    fi
  fi

  cargo "$@"
}

# Cargo.lock 변경 감지를 위한 스냅샷
LOCK_HASH_BEFORE=$(shasum Cargo.lock 2>/dev/null || echo "none")

echo "Running cargo fmt check..."
run_cargo fmt --all -- --check

echo "Running daemon smoke tests..."
run_cargo test -p opensession-daemon --quiet

# Cargo.lock 변경 여부 확인
LOCK_HASH_AFTER=$(shasum Cargo.lock 2>/dev/null || echo "none")
if [ "$LOCK_HASH_BEFORE" != "$LOCK_HASH_AFTER" ]; then
  echo ""
  echo "ERROR: Cargo.lock was modified during pre-commit checks."
  echo "Please stage the updated Cargo.lock and re-run pre-commit:"
  echo "  git add Cargo.lock && git commit"
  exit 1
fi

echo "Fast pre-commit checks passed."
