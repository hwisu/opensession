#!/bin/sh
# Pre-push hook: full local validation gate (docker-free, git-native)
set -e

ROOT_DIR=$(pwd)

run_cargo() {
    if command -v rustup >/dev/null 2>&1; then
        RUSTC_BIN=$(rustup which --toolchain stable rustc 2>/dev/null || true)
        CARGO_BIN=$(rustup which --toolchain stable cargo 2>/dev/null || true)
        if [ -n "$RUSTC_BIN" ] && [ -n "$CARGO_BIN" ]; then
            RUSTC_VER=$("$RUSTC_BIN" --version | awk '{print $2}' | tr '.' '_')
            TOOLCHAIN_BIN=$(dirname "$RUSTC_BIN")
            PATH="$TOOLCHAIN_BIN:$PATH" RUSTC="$RUSTC_BIN" CARGO_TARGET_DIR="$ROOT_DIR/target-rustup-$RUSTC_VER" "$CARGO_BIN" "$@"
            return
        fi
    fi

    cargo "$@"
}

echo "=== Running workspace clippy ==="
run_cargo clippy --workspace --exclude opensession-worker -- -D warnings

echo "=== Running Worker (wasm) checks ==="
run_cargo check --locked --manifest-path crates/worker/Cargo.toml --target wasm32-unknown-unknown
run_cargo clippy --locked --manifest-path crates/worker/Cargo.toml --target wasm32-unknown-unknown -- -D warnings

if command -v npm >/dev/null 2>&1; then
    echo "=== Running frontend checks ==="
    (cd "$ROOT_DIR/packages/ui" && npm ci --prefer-offline --no-audit)
    (cd "$ROOT_DIR/web" && npm ci --prefer-offline --no-audit)
    mkdir -p "$ROOT_DIR/web/node_modules/@opensession"
    rm -f "$ROOT_DIR/web/node_modules/@opensession/ui"
    ln -sf "$ROOT_DIR/packages/ui" "$ROOT_DIR/web/node_modules/@opensession/ui"
    (cd "$ROOT_DIR/web" && npm run check)
else
    echo "WARNING: npm not found; skipping frontend checks."
fi

echo "=== Running migration parity check ==="
"$ROOT_DIR/scripts/check-migration-parity.sh"

echo "=== Running workspace tests ==="
run_cargo test --workspace --exclude opensession-e2e

echo "=== Running E2E compile smoke ==="
run_cargo test -p opensession-e2e --tests --no-run

echo "=== Pre-push checks passed ==="
