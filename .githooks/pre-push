#!/bin/sh
# Pre-push hook: heavy local validation gate before CI
set -e

COMPOSE="docker compose -f docker-compose.yml -f docker-compose.test.yml"
ROOT_DIR=$(pwd)

run_cargo() {
    if command -v rustup >/dev/null 2>&1; then
        RUSTC_BIN=$(rustup which --toolchain stable rustc 2>/dev/null || true)
        CARGO_BIN=$(rustup which --toolchain stable cargo 2>/dev/null || true)
        if [ -n "$RUSTC_BIN" ] && [ -n "$CARGO_BIN" ]; then
            RUSTC_VER=$("$RUSTC_BIN" --version | awk '{print $2}' | tr '.' '_')
            TOOLCHAIN_BIN=$(dirname "$RUSTC_BIN")
            PATH="$TOOLCHAIN_BIN:$PATH" RUSTC="$RUSTC_BIN" CARGO_TARGET_DIR="$ROOT_DIR/target-rustup-$RUSTC_VER" "$CARGO_BIN" "$@"
            return
        fi
    fi

    cargo "$@"
}

echo "=== Running workspace clippy ==="
run_cargo clippy --workspace --exclude opensession-worker -- -D warnings

echo "=== Running Worker (wasm) checks ==="
run_cargo check --manifest-path crates/worker/Cargo.toml --target wasm32-unknown-unknown
run_cargo clippy --manifest-path crates/worker/Cargo.toml --target wasm32-unknown-unknown -- -D warnings

if command -v npm >/dev/null 2>&1; then
    echo "=== Running frontend checks ==="
    (cd "$ROOT_DIR/packages/ui" && npm ci --prefer-offline --no-audit)
    (cd "$ROOT_DIR/web" && npm ci --prefer-offline --no-audit)
    mkdir -p "$ROOT_DIR/web/node_modules/@opensession"
    rm -f "$ROOT_DIR/web/node_modules/@opensession/ui"
    ln -sf "$ROOT_DIR/packages/ui" "$ROOT_DIR/web/node_modules/@opensession/ui"
    (cd "$ROOT_DIR/web" && npm run check)
else
    echo "WARNING: npm not found; skipping frontend checks."
fi

echo "=== Cleaning up previous volumes ==="
$COMPOSE down -v

echo "=== Building Docker image (cached) ==="
$COMPOSE build

echo "=== Starting server ==="
$COMPOSE up -d

echo "=== Waiting for server ==="
for i in $(seq 1 30); do
    if curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
        echo "Server is ready"
        break
    fi
    if [ "$i" -eq 30 ]; then
        echo "Server failed to start"
        $COMPOSE logs
        $COMPOSE down
        exit 1
    fi
    sleep 2
done

echo "=== Running E2E tests ==="
E2E_BASE_URL=http://localhost:3000 cargo test -p opensession-e2e --test docker -- --test-threads=1
E2E_EXIT=$?

echo "=== Stopping server ==="
$COMPOSE down

if [ $E2E_EXIT -ne 0 ]; then
    echo "E2E tests failed!"
    exit 1
fi

echo "=== E2E tests passed ==="
